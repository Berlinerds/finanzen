<?php

/**
 * @file
 *
 * Finanzen module
 */
 
 /**
* Implements hook_perm().
*/
function finanzen_perm ()
{
  return array ('administer finanzen', 'Add hours to projects');
}

/**
* Implements hook_help().
*/

#function resourcereservation_help ( $path, $arg )
#{
#  $output=''; // para construir la salida
#  switch ( path )
#  {
#    case 'admin/help#resourcereservation':
#      $output .= '<p>' . t('Módulo que permite la reserva de recursos.') . '</p>';
#      break;
#  }
#  return $output;
#}

/**
 * Implements hook_menu().
 */
function finanzen_menu() {

  $items = array();

  $items['finanzen'] = array(
    'title' => t('Finanzen'),
    'description' => 'The module information page',
    'page callback' => 'finanzen_mainpage',
    'access arguments' => array('Add hours to projects'),
    'type' => MENU_CALLBACK,
  );
  
  $items['finanzen/insert/%/%'] = array(
   'title' => t('Add hours to Project'),
   'page callback' => 'finanzen_insert',
   'page arguments' => array ( 2, 3 ),
   'access arguments' => array('Add hours to projects'),
   'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * This function calculates how many days has a given month 
 */
function _finanzen_days_in_month($month, $year) 
{ 
  // calculate number of days in a month 
  return $month == 2 ? ($year % 4 ? 28 : ($year % 100 ? 29 : ($year % 400 ? 28 : 29))) : (($month - 1) % 7 % 2 ? 30 : 31); 
} 

/**
 * The default page for /finanzen url, now showing some basic
 * information.
 */
function finanzen_mainpage() {

  global $user;                      
  
  //This gets today's date
  $date = time () ;
  //This puts the day, month, and year in seperate variables
  //$day = date('d', $date) ;
  $month = date('m', $date) ;
  $year = date('Y', $date) ;
  //Here we generate the first day of the month
  $first_day = mktime(0,0,0,$month, 1, $year) ;
  
  $content .= "Time Sheet for " . $user->name . " / " . date('F Y', $first_day) ;
  $content .= "<br/>";
  
  $number_days = _finanzen_days_in_month($month, $year);

  $all_groups = $user->og_groups;
  
  $array_header = array('date' => t("Date"));
  
  foreach ($all_groups as $group) {
    $group_node = node_load ($group[nid]);
    $array_header[] = $group_node->field_project_code[0]["value"];
  }
  
  $rows = array ();
  
  for ($i = 1; $i <= $number_days; $i++) {
    $day = mktime(0,0,0,$month, $i, $year);
    $row = array ();
    $row['date'] = date('l, d.m.Y', $day);
    foreach ($all_groups as $group) {
      $link = "finanzen/insert/" . $group[nid] . "/" . $day;
      $row[$group[title]] = "0" . " hours <br/> " . l ( t('Modify'), $link ) ;
    }

    $rows[] = $row; 
  }
  
  $content .= theme_table($array_header, $rows);
  
  return $content;
}

function finanzen_insert ( $project_id, $date )
{
  $content .= drupal_get_form ( 'finanzen_insert_form', $project_id, $date  );
 
  return $content;
}

function finanzen_insert_form ( $form, $project_id, $date )
{
/*
  $query = "SELECT rr.nid, rr.timeinterval FROM {resourcereservation_resource} rr WHERE rr.resource_id=%d";
  $queryResult = db_query ( $query, $resource_id );
  $resource = db_fetch_object ( $queryResult );
  
  $query2 = "SELECT rr.date, rr.nid, rr.date_timestamp FROM {resourcereservation_round} rr WHERE rr.nid=%d";
  $queryResult2 = db_query ( $query2, $resource->nid );
  $round = db_fetch_object ( $queryResult2 );

  $humanDate = format_date($round->date_timestamp, $type = 'custom', $format = 'd.m.Y');
 */
  $form = array
    (
      'make_reservation' => array
      (
        '#type' => 'fieldset',
        //'#title' => t( 'Jetzt Termin buchen, der <b>' . /*$humanDate .*/ '</b> in die Uhrzeit <b>' . $resource->timeinterval . '</b>' ),
        'name' => array ( '#type' => 'textfield', "#description" => "Name" ),
        'email' => array ( '#type' => 'textfield', "#description" => "Bally-Wulff E-Mail Adresse" ),
        'phone_extension' => array ( '#type' => 'textfield', "#maxlength" => 3, "#description" => "Durchwahl" ),
        //'resourceid' => array ( '#type' => 'hidden', "#default_value" => $resource_id ),
        //'roundid' => array ( '#type' => 'hidden', "#default_value" => $round->nid ),
        'submit' => array ( '#type' => 'submit',  '#value' => t('Speichern'),  ),
      ),
    );
    
    return $form;
}

