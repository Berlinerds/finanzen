<?php

/**
 * @file
 *
 * Finanzen module
 */
 
/**
* Implements hook_perm().
*/
function finanzen_perm ()
{
  return array ('administer finanzen', 'add hours to projects');
}

/**
* Implements hook_init().
*/
function finanzen_init(){
  drupal_add_css(drupal_get_path('module', 'finanzen') .'/css/finanzen.css');
}

/**
* Implements hook_help().
*/

#function resourcereservation_help ( $path, $arg )
#{
#  $output=''; // para construir la salida
#  switch ( path )
#  {
#    case 'admin/help#resourcereservation':
#      $output .= '<p>' . t('Módulo que permite la reserva de recursos.') . '</p>';
#      break;
#  }
#  return $output;
#}

/**
 * Implements hook_menu().
 */
function finanzen_menu() {

  $items = array();

  $items['finanzen'] = array(
    'title' => t('Finanzen'),
    'description' => 'The module information page',
    'page callback' => 'finanzen_mainpage',
    'access arguments' => array('add hours to projects'),
    'type' => MENU_CALLBACK,
  );
  
  $items['finanzen/insert/%/%/%'] = array(
   'title' => t('Add hours to Project'),
   'page callback' => 'finanzen_insert',
   'page arguments' => array ( 2, 3, 4 ),
   'access arguments' => array('add hours to projects'),
   'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * This function calculates how many days has a given month 
 */
function _finanzen_days_in_month($month, $year) 
{ 
  // calculate number of days in a month 
  return $month == 2 ? ($year % 4 ? 28 : ($year % 100 ? 29 : ($year % 400 ? 28 : 29))) : (($month - 1) % 7 % 2 ? 30 : 31); 
} 

/**
 * The default page for /finanzen url, now showing some basic
 * information.
 */
function finanzen_mainpage() {

  global $user;                    
  
  //This gets today's date
  $date = time () ;
  //This puts the day, month, and year in seperate variables
  //$day = date('d', $date) ;
  $month = date('m', $date) ;
  $year = date('Y', $date) ;
  //Here we generate the first day of the month
  $first_day = mktime(0,0,0,$month, 1, $year) ;
  
  $content .= "<p>Time Sheet for " . $user->name . " / " . date('F Y', $first_day) . "</p>" ;
  
  $number_days = _finanzen_days_in_month($month, $year);

  $all_groups = $user->og_groups;
  
  $array_header = array('date' => t("Date"));
  
  foreach ($all_groups as $group) {
    $group_node = node_load ($group[nid]);
    $array_header[] = $group_node->field_project_code[0]["value"];
  }
  
  $rows = array ();
  
  for ($i = 1; $i <= $number_days; $i++) {
    $day = mktime(0,0,0,$month, $i, $year);
    $row = array ();
    $row['date'] = date('l, d.m.Y', $day);
    foreach ($all_groups as $group) {
      $link = "finanzen/insert/" . $group[nid] . "/" . $day . "/" . $user->uid;
      $query = "SELECT fuhp.hours FROM {finanzen_user_hours_projects} fuhp 
                WHERE fuhp.date=%d AND fuhp.uid=%d AND fuhp.project_id=%d" ;
      $queryResult = db_query ( $query, $day, $user->uid, $group[nid] );
      $resource = db_fetch_object ( $queryResult );
      if ($resource) {
        $row[$group[title]] = '<span class="inserted-time">' . round($resource->hours, 2) . " hours</span> " 
                              . l ( t('Modify'), $link ) ;
      } 
      else {
        $row[$group[title]] = "0" . " hours " . l ( t('Insert'), $link ) ;
      }
    }

    $rows[] = $row; 
  }
  
  $content .= theme_table($array_header, $rows);
  
  return $content;
}

/* --------------------- INSETR TIME - PROJECT --------------------------- */

function finanzen_insert ( $project_id, $date, $user_id )
{
  $content .= drupal_get_form ( 'finanzen_insert_form', $project_id, $date, $user_id  );
 
  return $content;
}

function finanzen_insert_form ( $form, $project_id, $date, $user_id )
{
/*
  $query = "SELECT rr.nid, rr.timeinterval FROM {resourcereservation_resource} rr WHERE rr.resource_id=%d";
  $queryResult = db_query ( $query, $resource_id );
  $resource = db_fetch_object ( $queryResult );
  
  $query2 = "SELECT rr.date, rr.nid, rr.date_timestamp FROM {resourcereservation_round} rr WHERE rr.nid=%d";
  $queryResult2 = db_query ( $query2, $resource->nid );
  $round = db_fetch_object ( $queryResult2 );

  $humanDate = format_date($round->date_timestamp, $type = 'custom', $format = 'd.m.Y');
 */
 
  $human_date = date('l, d.m.Y', $date);
  $project_node = node_load ($project_id);
  $project_code = $project_node->field_project_code[0]["value"];
 
  $form = array (
    'insert_time' => array (
      '#type' => 'fieldset',
      '#title' => t( 'How many hours did you work in the project <b>' . $project_code . '</b> on <b>' . $human_date . '</b> ?' ),
      'hours' => array ( '#type' => 'textfield', 
                         '#title' => 'Hours',
                         '#default_value' => '8',
                         '#maxlength' => 2,
                         '#required' => TRUE,
                         '#prefix' => '<div class="insert-time-hours-field">',
                         '#suffix' => '</div>',
                       ),
      'minutes' => array ( '#type' => 'textfield',
                           '#title' => 'minutes',
                           '#default_value' => '0',
                           '#maxlength' => 2,
                           '#required' => TRUE,
                           '#prefix' => '<div class="insert-time-minutes-field">',
                           '#suffix' => '</div>',
                         ),
      'project_id' => array ( '#type' => 'hidden', "#default_value" => $project_id ),
      'date' => array ( '#type' => 'hidden', "#default_value" => $date ),
      'user_id' => array ( '#type' => 'hidden', "#default_value" => $user_id ),
      'submit' => array ( '#type' => 'submit',  '#value' => t('Save'), ),
    ),
  );

  return $form;
}

function finanzen_insert_form_submit ( $form, &$form_state )
{

  $user_id = $form_state['values']['user_id'];
  $date = $form_state['values']['date'];
  $hours = $form_state['values']['hours'];
  $minutes = $form_state['values']['minutes'];
  $project_id = $form_state['values']['project_id'];
  $hours_total = $hours + ((1/60) * $minutes);
  
  $query = "INSERT into {finanzen_user_hours_projects} ( uid, date, hours, project_id ) 
            values ( %d, '%s', %f, %d )";
  $queryResult = db_query ( $query, $user_id, $date, $hours_total, $project_id );

#  $last_round_id = db_last_insert_id('resourcereservation_round', 'nid');
#  
#  /* Este if en un workaround para evitar que por el almacenamiento del error de la query en la tabla watchdog
#     confunda la posterior llamada a db_affected_rows (rows afectadas en la ultima query) */
#  if ($queryResult) {
#    // $number_affected_rows =  db_affected_rows();
#    //$last_round_id = db_last_insert_id('resourcereservation_round', 'nid');
#    $query = "INSERT into {resourcereservation_resource} ( nid, timeinterval ) values ( %d, '%s' ) ";
#    $interval = array( '9:00 - 9:20',   
#                       '9:30 - 9:50',
#                       '10:00 - 10:20', 
#                       '10:30 - 10:50',
#                       '11:00 - 11:20',
#                       '11:30 - 11:50',
#                       '12:00 - 12:20', 
#                       '12:30 - 12:50',
#                       '13:00 - 13:20', 
#                       '13:30 - 13:50',
#                       '14:00 - 14:20', 
#                       '14:30 - 14:50',
#                       '15:00 - 15:20', 
#                       '15:30 - 15:50');
#    $i=0;
#    while ($i < sizeof($interval)) {
#      $queryResult = db_query ( $query, $last_round_id, $interval[$i] );
#      $i++;
#    }
#    drupal_set_message ( t ( "Danke. Der Tag wurde richtig erstellt: " . $date . '.' ) );
#  }
#  else {

#  }

  $form_state['redirect'] = 'finanzen';
}

